apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: heimdall-iscsi
    namespace: democratic-csi
spec:
    interval: 15m
    chart:
        spec:
            chart: democratic-csi
            version: 0.14.7
            sourceRef:
                kind: HelmRepository
                name: democratic-csi
                namespace: flux-system
            interval: 15m
    timeout: 20m
    maxHistory: 3
    driftDetection:
        mode: warn
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        csiDriver:
            name: org.democratic-csi.heimdall-iscsi
        storageClasses:
            - name: heimdall-iscsi-csi
              defaultClass: false
              reclaimPolicy: Delete
              volumeBindingMode: Immediate
              allowVolumeExpansion: true
              parameters:
                # for block-based storage can be ext3, ext4, xfs
                # for nfs should be nfs
                fsType: ext4
                detachedVolumesFromSnapshots: "false"
              mountOptions: []
              secrets:
                provisioner-secret: null
                controller-publish-secret: null
                node-stage-secret: null
                #      # any arbitrary iscsiadm entries can be add by creating keys starting with node-db.<entry.name>
                #      # if doing CHAP
                #      node-db.node.session.auth.authmethod: CHAP
                #      node-db.node.session.auth.username: foo
                #      node-db.node.session.auth.password: bar
                #
                #      # if doing mutual CHAP
                #      node-db.node.session.auth.username_in: baz
                #      node-db.node.session.auth.password_in: bar
                node-publish-secret: null
                controller-expand-secret: null
        volumeSnapshotClasses:
            - name: heimdall-iscsi-snapshot-csi
              parameters:
                detachedSnapshots: "true"
              secrets:
                snapshotter-secret: null
        driver:
            config:
                driver: zfs-generic-iscsi
                sshConnection:
                    host: 10.1.0.63
                    port: 22
                    username: root
                    privateKey: ENC[AES256_GCM,data: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,iv:MrPZMGK8YGtqNYK0zzGPcch5+QQtHiL7sBLVSE2HmnA=,tag:iNB/zGABY8JS0noDdQjyUA==,type:str]
                zfs:
                    cli:
                        #  sudoEnabled: true
                        paths:
                            zfs: /usr/sbin/zfs
                            zpool: /usr/sbin/zpool
                            sudo: /usr/bin/sudo
                            chroot: /usr/sbin/chroot
                    datasetProperties:
                        org.freenas:description: '{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}'
                    datasetParentName: Heimdall/k8s/main-cluster/iscsi/pvc
                    detachedSnapshotsDatasetParentName: Heimdall/k8s/main-cluster/iscsi/snapshot
                    # "" (inherit), lz4, gzip-9, etc
                    zvolCompression: inherit
                    # "" (inherit), on, off, verify
                    zvolDedup: inherit
                    zvolEnableReservation: false
                    # 512, 1K, 2K, 4K, 8K, 16K, 64K, 128K default is 16K
                    zvolBlocksize: 4k
                iscsi:
                    shareStrategy: targetCli
                    # https://kifarunix.com/how-to-install-and-configure-iscsi-storage-server-on-ubuntu-18-04/
                    # https://kifarunix.com/how-install-and-configure-iscsi-storage-server-on-centos-7/
                    # https://linuxlasse.net/linux/howtos/ISCSI_and_ZFS_ZVOL
                    # http://www.linux-iscsi.org/wiki/ISCSI
                    # https://bugzilla.redhat.com/show_bug.cgi?id=1659195
                    # http://atodorov.org/blog/2015/04/07/how-to-configure-iscsi-target-on-red-hat-enterprise-linux-7/
                    shareStrategyTargetCli:
                        #sudoEnabled: true
                        basename: iqn.1993-08.org.debian
                        tpg:
                            attributes:
                                # set to 1 to enable CHAP
                                authentication: 0
                                # this is required currently as we do not register all node iqns
                                # the effective outcome of this is, allow all iqns to connect
                                generate_node_acls: 1
                                cache_dynamic_acls: 1
                                # if generate_node_acls is 1 then must turn this off as well (assuming you want write ability)
                                demo_mode_write_protect: 0
                            auth: null
                            # CHAP
                            #userid: "foo"
                            #password: "bar"
                            # mutual CHAP
                            #mutual_userid: "baz"
                            #mutual_password: "bar"
                        block:
                            attributes:
                                # set to 1 to enable Thin Provisioning Unmap
                                emulate_tpu: 0
                    targetPortal: 10.1.0.63:3260
                    # for multipath
                    targetPortals: []
                    # leave empty to omit usage of -I with iscsiadm
                    interface: ""
                    # MUST ensure uniqueness
                    # full iqn limit is 223 bytes, plan accordingly
                    # default is "{{ name }}"
                    nameTemplate: '{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}-{{ parameters.[csi.storage.k8s.io/pvc/name] }}'
                    namePrefix: csi-
                    nameSuffix: -cluster
sops:
    shamir_threshold: 3
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1agltukf6ellg2guets9gq4th2nmunc965uflry7fdahtj7ea8uxq8q54ae
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBSbnJlMzgwbWExME1kbmR6
            czBqVG54OVdWVFZWSkdBTWFZUWpCM29ya21vCkV6eVZibVJsOWdTZXpjbzRhWThs
            WXlXRUNQblZxMFBWZEI0dElROXJCUG8KLS0tIGtqVWRGWlJqOUZXR3dmbmZnN3Jn
            UXBoWVZWWTh1ZFlFbndiRGJOcWRKbkUK/K5JTL7e2GbdrBABK0IbMyLdclZJCdvF
            WMu8+k3zYQ4ER21m+Aw9+x5kophnG6SHO6+mgPEH5t7CjjMjr6jhIQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-01-26T01:49:37Z"
    mac: ENC[AES256_GCM,data:l7m0vvfTgefDlOpAFLJaK5+tikdkAdeNXdcyTVZyd0174RNZ5Dk7v3pHDQevk5jHqqsQjrE/GyllPkreaNpk5UeJ+qi6YG7SrPElWU/pHrJf+3xtQygG8Yqlp8tyLZrHK8R04OIMlgKyCvxrdq7ebUAzNdDHimsRmz/ki58NVs8=,iv:EHE5TI5u9p4Dv2lUTS99JOwpYQCld2AECgs/PDU9iCE=,tag:6tr77vtXK20cGFFKxyRRyw==,type:str]
    pgp: []
    encrypted_regex: ((?i)(privateKey))
    version: 3.9.1
