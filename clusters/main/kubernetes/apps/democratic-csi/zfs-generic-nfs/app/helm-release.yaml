apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: zfs-nfs
    namespace: democratic-csi
spec:
    interval: 15m
    chart:
        spec:
            chart: democratic-csi
            version: 0.14.6
            sourceRef:
                kind: HelmRepository
                name: democratic-csi
                namespace: flux-system
            interval: 15m
    timeout: 20m
    maxHistory: 3
    driftDetection:
        mode: warn
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        csiDriver:
            #ENC[AES256_GCM,data:ohqLoXo6tdfX6WDfhaxHV8HFdeEAZmtgNA9kvZlE2deM8BISgixtSDQYJWUZ2w==,iv:x9xQ8O52rsWOQdHBk4PGog81ZMYSX07V0C2mgIljDYc=,tag:NpFaLxe5/WbpvIh++iFEYw==,type:comment]
            name: ENC[AES256_GCM,data:uuzj5dWON1hHKL2/aOTYlQTcoIsTWg==,iv:wz8DAGnAYAuQ9hE/ItW2jp6NQ3YmAri2ia8uC7XcgiA=,tag:T4HolTmXijy9NOTRGqsz3Q==,type:str]
            fsGroupPolicy: ENC[AES256_GCM,data:UC7PGQ==,iv:D1Kp2OKRHKrquGb1xcOq0RwgtBTHSu+InDoflXUDS/8=,tag:qwB315Mxz37/fS/XlcwjzQ==,type:str]
        # add note here about volume expansion requirements
        storageClasses:
            - name: zfs-generic-nfs-csi
              defaultClass: true
              reclaimPolicy: Delete
              volumeBindingMode: Immediate
              allowVolumeExpansion: true
              parameters:
                # for block-based storage can be ext3, ext4, xfs
                # for nfs should be nfs
                fsType: nfs
                # if true, volumes created from other snapshots will be
                # zfs send/received instead of zfs cloned
                detachedVolumesFromSnapshots: "false"
                # if true, volumes created from other volumes will be
                # zfs send/received instead of zfs cloned
                # detachedVolumesFromVolumes: "false"
              mountOptions:
                - noatime
                - nfsvers=3
              secrets:
                provisioner-secret: null
                controller-publish-secret: null
                node-stage-secret: null
                node-publish-secret: null
                controller-expand-secret: null
        # if your cluster supports snapshots you may enable below
        volumeSnapshotClasses:
            - name: zfs-generic-nfs-snapshot-csi
              parameters:
                #  # if true, snapshots will be created with zfs send/receive
                detachedSnapshots: "true"
        #  secrets:
        #    snapshotter-secret:
        driver:
            config:
                driver: zfs-generic-nfs
                sshConnection:
                    host: 10.1.0.63
                    port: 22
                    username: root
                    # use either password or key
                    privateKey: ENC[AES256_GCM,data:UIh9fM1Ijh90LWVRmIQ8JqlCicD8HEC6xPrT9Hiz0YyLTmuNcQq2qHyZtyuYvWurxaap/pgG9VKPscID/JSdE1zfn6/ZMIrfiX/SqxrnqvRwPhH0MDycEmITqAtS4TnmBXqI+Vroza0Q2ccud/m2wMAJs12BQ8h0Jt5U7S/aXj8H2loiGNeLK6xKOH4/uZ2CgiYr8GmUkNDez+2MpM1LkPBJKIEpMN0Ctsnfgigvgzut7xEp+Ec8+iEkxRge+4clhE0HIzxMn8AtMRr12ddjlHcjIMXD54LGDafQIKZxdnoum0uXPXjd1TbGbbb6WuZaDT5qThtUmVUxGDMR66JdqhTVGq1GChCBo8yzKXRA2s7VAg69zVy3JpPHlUE3/VIIAsV4F+kKIqp3a+FazTt/QX1xdzt34+ys920D/uwVkmjgePKmh+mzbwvi6UenT770IUmQRKLSmUy9LSMPB06VdAx6whnKIQF2CgHcndw5hIk0RqJ7UNahkaG6wT19V0JnReSi9UkPYel5WeZrq+xYIH7b6oPkrWgW3TQ5W9jULj4ziiOc84nsoUQwdJcYqqZ1cc4BfSYPd0hCt0ZN87yIoueYrfXnD5VF5KnTNSrN7X/++kHEW7a/5vGV8fHM+6Gtr23L2p3bJY6D0HSnGQ2l3eUm0fmkFmXSE0+K27hDbNOe7EM+bH4aKfK7OPxIwPbTGqdsJEh/VD2FplDL22+KWRcirX1r8U/mKlk99QkkfSFpz8aZ7XsvruHV9M9CLQOQJfc2q1xu6yJC1Jir6QgnGuqHV9WXlnpn3atNvxtCdmU8pMQ8t54fIoJbK5084fTDOURxBKjfv1R6vQ9DqtUplWKREWnknlb3oVDevFg8nX+ur7fATBUIZrxUULEb0AlmXcRQoJknhsuuulU3GcZjkBmUvGaI3DlZbbi6H4Xwm2kdBuOcN+wYwbhSjBAhu6bpU6uI9cH969pQ/WA6hwLTySISd6qXRzWWFij87SxLbgl1tBdEYR9KfU2/jWmAZCvjsxdpVYViZkJ9WxeQVm+vANQiL892xMAmz/qRwNZLpZ004X39mumetqxNlpxY2yg6k9VMS3nE1wgk/kj0bJW7FBzF8P5DRjrFKFRzNv5oYfJmqnps5BHy1Me9MK1N2Os8YIwWl8XU4CN23idx4TyWGAhKXJ8MDXXY3BxKIQgy9oa03qjeFx2KhVhHZIuf5TyRCXay5EB5rs91AfkY6mawfcltZVHdjij1UOo9Um1XBOzcN7OIJiy5LnGIdCBYZZ1/QJW9v4tTmenCZ3GTyzi4r8s9syaKtXRP9KbPZPcJtRzUpfd9sPetO4CwZSWXEfspHg7Ri2vg4wQZI/rrvQkc5XB+x5hxBxGT9Skw02vWuYPYHeOuQuXByHae8gOtdDzgmnqvLbzQsxE0k5A8j1aafMMwodMz0Q5RAEjO8FYZKna1ZS9fQjzU2rx4kfoULrrCjkfR9IIkeEKh2uxqKTowicfb1mEF6/K+k89fGn02IlK6LQxn5ZSYNA9FKhiMPjF0mcdfWBsPO3BR3bhiUbE36bwf/Q3tqQ9qcBIor+jfAuu/wSflPorT6DEXShaDjxAVz4eQbo/m23ebh5rRtZs+SpiWpcWUNS6R89xBLG4P9vFXKlAAdXZtnNG4s+s7R89fWEvpiwEmBgYgX1VBpi3e1pooJXfl8ul4ODtF6ZVYRtlATUGjOiD7I1hnKmfGva8lXD0kYcWdad2quo3Z/xc7nmiERa6SrU/Cf2TswxxCeRPdjynas70Sg5NZVB4jf/GftyNxdX5YK4l9wiDkKNm08P3VeuFtK+mEEe5rOIiGoLAeN9bgF+TiHquthx5fe6f00wV7HoH143BZEChNTyohmobDqiokkJSrNkikGAPa6yJxUSZXmj+uQX/8i9VbfNX8FRe8S2Sns8P24N39ae1AtOPYIwkah77Xm/A3W1FDLioGP2IjKuwG+CJWoL3jw1PXBoap5f28qE/w1PfgnrUIKoev2OdaDvvWjXNvZ6+Tq42gea+uXSmI2ROJfoUH8jZD4I1SiAz4L+jKkzYeBq2vDL+hO3XamlqCp3tugE5HSczOHKr0ql1JQfOuBGlB2LVX4iMrN+Gz/5vkXpqoxVbLsQc8ltrNK5V5TjWJy32pAjWXMnmKpaorVXOEqcii+Dz8yY95a+hj1+XB7DI6f7jj55nYN0Ov6CU6CmY4Y23bopsH1589bUFunmV3rO+LZSOzDaz3+2Bvnos/EI7WOv5HwTXDzuN/eIfOdiPy5M82ZtbgHlWLwHLVjeDQ/gq06yIGYwIQuY9kEhAH4W+ifX8P2gW+bGz18VL8zWtO+PgSLV+83FZIDbJrRSNmPNRAznkcq5l30HvRBKJsqOcma7jSRS5opB/Dm2nZKmoCNgyh9rNPPrkHzLlfI60NUwV1WfSyxfJMma8TQfUbksMaMUPl06AJzloGFx5XiJDBmPiDjvQa1et9cIyDSJ+YNsathdkRji/1Zao+lJhof5s6Z4DQrg8vx75HmdLqO8qAZh1OwVw3OsjuQTXA9a5fOMDfVTxnzY+/25xTGgl9Zql9AwQj2k2TlSnSvDA/QgSsMQ7MYgXKE2NUgSFc3XMFfNz/la2L1pLyFE/KJ+Uis++2lzkj7JnaHi3+Aui9Yw09opxsLUlM4/a5lyJ5mJQpLxtoUKHcz+HNFZHe+mKxAim2TqONgEJdLHKzPazddfrT3MXZNQwZuXrvCTs2TReprhFqy2BKNarOxqRwm/+L5xSAVcNvgqbquFQolw7Vf8XFqGtRu+etGrLsfAuEaYlHJ+jRtm+HgS3+mLexfE+jEIEOGF1Tm8ykYsSh/GNoqvKYMcwmK1BYb/5lv9Ft9fjmMRyigGljI53aVCoOADQimgF1o1WRV3RPlLq/JQd/8LSGnUI/boobTm+nVAX8t7FqEpxBF3pZR28ATfVXpLeCtwBOmA+MHbwgiYy/qhWwcA35rhaU/ftsQubev6e5TpTMYBpOjsBW6Bc+KzxQgMQ4H8cFxdXuxe9Rf9wOGTbTyspzEVubW3nrUPKuai+yFtKJK7v5lplQ6vZr2gpYaZ+ihgTdq0LVSuX7PhqwG7gVp95bHfNOaKK7/p8XOyhBL21ipFVJnsb9dvtRbvqNo7MbfTmPyLpwRbhV0dValW4PXff7y/O9+4AUPY2YKDoj5GDpwB3q5IUb+WTHiWOk02tkPMlM8MNyQIpcky1HU5jLiurHmZFCnxUFQpAmwp535DubBhWv4lJHz4p3shnzwXDgHyOMzTIg+Fkt2rv03j/3A4GpLlLT/gu405fqNe8T5WRrNefGXWVWo9ZUHVdxlUTfRDO7Ysur2+xA0ALHYBZfSpfQ1JE7bjXeFEtUnqzmNr/cwtw0bBeBgDLAGMXTd9B+6Bk6oVV3lpWKi4Owab6U/hI5Y1FilrabNYv0g3SJ0OdFKcu16vFwilrwWSqPNq4XPmO/McwvvnQCvLefw2apo55TcfBixfF8OV+j+jxw23KvR76eJiKtflHrOcLpuJSvJPOyAwGC4VH1BeDlF7ulyzYCc8SJWyikUmkPhlPMuHV516zNM+34O4ObHIHGDYjK0nx/ZhVFOA3M4MIEEyD/All1nzIgW18eclTm0UWBDe2UNsAVXbRJ+QT0MWLuf1yGWHAdtJ7RpK7kfi2OXmaJVoPL+fBuXCmdq337eBB8A8iPG8or+V4TUrENjDPOg5p7icLU8LkvC6xdVGzuCU68r0FD7G8HUH6ekaZI8HTBfeM3kGgqrYqF/Kh19gu46x/LHQW8i6pZbi+y4sFyPKIU1d1/hQXTb7JdHlN/LPtnLb4G3gR2Z0NiKcTb90vDd88pfODjIMkQXb6SIwgtcqtCY0A/F6wYEGdJy8++J6cbNYYWk+C/5fwVLtn6E7vvx0yHgI090fyejkK8pvK9WHKJem0fWgkPNVMzCUM9aLPnzAZAS6RGre5QcdqXeCdD15Oz/EEQNq8ZbtvygGuBKhaZ+p5/vjuI4OAR4E2fDg33iSb0Y7viQ/r8Svb7Nc2BiKxP64pS2NykygoTKkmIbYUqokbV1LS/AbmzL80drtWqXuBgAqNkbQeVRj2gs6tf8/PGSH5oTsCqG6AEwOFrpe0go2APLVxrDK/huBxSxJ3jNOKF71DwZ7bzTN/qmZB4hhz82tObd3QZytThXE1cEGzlAzAF5JzHSslnn3QX/VUavGz76nCpKIbZ5PO+1DQ3pHNO0IAGIHVKMR8AvIYuF1pdsnX5CDZ56tKbsLXNCc+EpHaJMiwYqBJAAb/+egd+HUygVYJurMqp+G/6ZxWe2xLxho146v94/cGcEEVPbwaAXezA3kX1bqj7PtEfUqHWZPgHi+vJemR/ayIyTDulILvItOMLDBQMDs1J11reQxWhO+ksGiSlcHtpNM3Ox2XZ/q37RvHbi/XQ1nuV1t5xAtseox+ZFpoCzofVK6hqfYNyOL+7DYkdyLvLk685SEem60KP,iv:2EouwTMVfoCrLABGEtzFQopBX1REkTiEv9lsWfdEYoQ=,tag:RpkHBEJxrOjlukP+EvL46Q==,type:str]
                zfs:
                    # can be used to override defaults if necessary
                    # the example below is useful for TrueNAS 12
                    cli:
                        #  sudoEnabled: true
                        paths:
                            zfs: /usr/sbin/zfs
                            zpool: /usr/sbin/zpool
                            sudo: /usr/bin/sudo
                            chroot: /usr/sbin/chroot
                    # can be used to set arbitrary values on the dataset/zvol
                    # can use handlebars templates with the parameters from the storage class/CO
                    #datasetProperties:
                    #  "org.freenas:description": "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
                    #  "org.freenas:test": "{{ parameters.foo }}"
                    #  "org.freenas:test2": "some value"
                    datasetParentName: Heimdall/k8s/main-cluster
                    # do NOT make datasetParentName and detachedSnapshotsDatasetParentName overlap
                    # they may be siblings, but neither should be nested in the other
                    # do NOT comment this option out even if you don't plan to use snapshots, just leave it with dummy value
                    detachedSnapshotsDatasetParentName: Heimdall/k8s/main-cluster-snapshots
                    datasetEnableQuotas: true
                    datasetEnableReservation: false
                    datasetPermissionsMode: "0777"
                    datasetPermissionsUser: 0
                    datasetPermissionsGroup: 0
                    #datasetPermissionsAcls:
                    #- "-m everyone@:full_set:allow"
                    #- "-m u:kube:full_set:allow"
                nfs:
                    # https://docs.oracle.com/cd/E23824_01/html/821-1448/gayne.html
                    # https://www.hiroom2.com/2016/05/18/ubuntu-16-04-share-zfs-storage-via-nfs-smb/
                    shareStrategy: setDatasetProperties
                    shareStrategySetDatasetProperties:
                        properties:
                            #sharenfs: "rw,no_subtree_check,no_root_squash"
                            sharenfs: "on"
                            # share: ""
                    shareHost: 10.1.0.63
sops:
    shamir_threshold: 3
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1agltukf6ellg2guets9gq4th2nmunc965uflry7fdahtj7ea8uxq8q54ae
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBoR0sydlFDV0QrbzRBc29X
            ZEc2T2NLcHVESkZnWFJBOFNuQUNiYWhwVTFBClNtNk9Qd2pyVHhWSmpmUUZpeWJz
            aVFyVkNkdngyRWYvdEM1YjVybE9VTVkKLS0tIEFmeTRSU0dUWEI0WnlyNVJ2Mjds
            ZzFnU2VIOUZSUnNma09MbVZvY3pvNlEKl1s+rngU/6xAg/Xve2wOKaeSORktJX2K
            uATxcfJJGqVoD4EITARRg6ZJD/P6kMB8XmbcuNLj+gVlq0JVR1gu8Q==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-01T22:51:11Z"
    mac: ENC[AES256_GCM,data:UU9SNjImCtZo4DYwnC/PrZGdWwA+sqCLnZM+ojgwTo4Dneb0f4vOniWt7M1og8f1H5lguYut088w5qT07BcraJcZQtYjXG8WYWIql2OZnxXIISmaDu/2ZVvoKOI5Wt0Zkl/zvIxu3+lICTYxC4MPqLoBS9I9muylogsdrHyv3iM=,iv:YF/+2IFFjxqE+TaZqvkb6pqYfKNJbMn1stx3eJViQc4=,tag:utWpcUi+6FCGPj3hEKBiag==,type:str]
    pgp: []
    encrypted_regex: ((?i)(privateKey|displayname|email|pass|ca|id|bootstraptoken|secretboxencryptionsecret|secrets|secrets|password|cert|secret($|[^N])|key|token|^data$|^stringData))
    version: 3.9.1
