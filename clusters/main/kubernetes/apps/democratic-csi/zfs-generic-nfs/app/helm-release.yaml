apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: zfs-nfs
    namespace: democratic-csi
spec:
    interval: 15m
    chart:
        spec:
            chart: democratic-csi
            version: 0.14.6
            sourceRef:
                kind: HelmRepository
                name: democratic-csi
                namespace: flux-system
            interval: 15m
    timeout: 20m
    maxHistory: 3
    driftDetection:
        mode: warn
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        csiDriver:
            #ENC[AES256_GCM,data:rlbWxaS4F7F+3uMnN0JB9rsyH8YmKXGc8wSO/I64tqErNys9ydD9S7/Q3f6gUA==,iv:+L05hMhdBiMlGnwKD4fDJTLLJoxNg9Wlz9CU/gGl0nM=,tag:JpbixVKXAY5ZXMayNle5/w==,type:comment]
            name: ENC[AES256_GCM,data:smkF17BTc/zh/l5lkeVzztApQFg9WA==,iv:93iF2NmeOba9IqXpbVL7Lcc+12sa2xMf/9wNtimxa/M=,tag:pWBAYYuZSQkblAyT24iS6A==,type:str]
            fsGroupPolicy: ENC[AES256_GCM,data:5iRMTQ==,iv:tjZ9NSsL16oIvdPZUJHf3Le7oqwXjOqUhNC/EkU2JuI=,tag:/lE+GSuQYrLuHPM5Gx8yAQ==,type:str]
        # add note here about volume expansion requirements
        storageClasses:
            - name: zfs-generic-nfs-csi
              defaultClass: true
              reclaimPolicy: Delete
              volumeBindingMode: Immediate
              allowVolumeExpansion: true
              parameters:
                # for block-based storage can be ext3, ext4, xfs
                # for nfs should be nfs
                fsType: nfs
                # if true, volumes created from other snapshots will be
                # zfs send/received instead of zfs cloned
                detachedVolumesFromSnapshots: "false"
                # if true, volumes created from other volumes will be
                # zfs send/received instead of zfs cloned
                # detachedVolumesFromVolumes: "false"
              mountOptions:
                - noatime
                - nfsvers=3
              secrets:
                provisioner-secret: null
                controller-publish-secret: null
                node-stage-secret: null
                node-publish-secret: null
                controller-expand-secret: null
        # if your cluster supports snapshots you may enable below
        volumeSnapshotClasses:
            - name: zfs-generic-nfs-snapshot-csi
              parameters:
                #  # if true, snapshots will be created with zfs send/receive
                detachedSnapshots: "true"
        #  secrets:
        #    snapshotter-secret:
        driver:
            config:
                driver: zfs-generic-nfs
                sshConnection:
                    host: 10.1.0.63
                    port: 22
                    username: root
                    # use either password or key
                    privateKey: ENC[AES256_GCM,data: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,iv:cMUFIWp5/U7D6xaZWrGKisNf6H+YNZyphOBRVigpFTs=,tag:6BnQacxP/JHl+by94iiMlA==,type:str]
                zfs:
                    # can be used to override defaults if necessary
                    # the example below is useful for TrueNAS 12
                    cli:
                        #  sudoEnabled: true
                        paths:
                            zfs: /usr/sbin/zfs
                            zpool: /usr/sbin/zpool
                            sudo: /usr/bin/sudo
                            chroot: /usr/sbin/chroot
                    # can be used to set arbitrary values on the dataset/zvol
                    # can use handlebars templates with the parameters from the storage class/CO
                    #datasetProperties:
                    #  "org.freenas:description": "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
                    #  "org.freenas:test": "{{ parameters.foo }}"
                    #  "org.freenas:test2": "some value"
                    datasetParentName: Heimdall/k8s/main-cluster
                    # do NOT make datasetParentName and detachedSnapshotsDatasetParentName overlap
                    # they may be siblings, but neither should be nested in the other
                    # do NOT comment this option out even if you don't plan to use snapshots, just leave it with dummy value
                    detachedSnapshotsDatasetParentName: Heimdall/k8s/main-cluster-snapshots
                    datasetEnableQuotas: true
                    datasetEnableReservation: false
                    datasetPermissionsMode: "0777"
                    datasetPermissionsUser: 0
                    datasetPermissionsGroup: 0
                    #datasetPermissionsAcls:
                    #- "-m everyone@:full_set:allow"
                    #- "-m u:kube:full_set:allow"
                nfs:
                    # https://docs.oracle.com/cd/E23824_01/html/821-1448/gayne.html
                    # https://www.hiroom2.com/2016/05/18/ubuntu-16-04-share-zfs-storage-via-nfs-smb/
                    shareStrategy: setDatasetProperties
                    shareStrategySetDatasetProperties:
                        properties:
                            #sharenfs: "rw,no_subtree_check,no_root_squash"
                            sharenfs: "on"
                            # share: ""
                    shareHost: 10.1.0.63
sops:
    shamir_threshold: 3
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1agltukf6ellg2guets9gq4th2nmunc965uflry7fdahtj7ea8uxq8q54ae
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBEQ3BVMnU4YlVxRjFXdzdO
            NDVHUFFwUTJVMjZJNVpOc3BJOWkwK0VvcUJRClEzQVpEWWFuclBQZXRvK3V1SXVh
            bjFaWHFrZUpLUFZCMTB0UlViUjNiTDQKLS0tIFdNRzlsZjgyNXhqUXlVWjNPc05K
            cEN3NDVYUVl6KzFPdFVMM21XVCtzdTAK2R84hAldI4i7/ZIHFj2vJPIZLFDSsmvu
            gwbJi6NBUN7GBGzmhVRjHTp9DjZeGKDCL0R+dZu03uLw1y2/5QoHzA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-01T23:39:06Z"
    mac: ENC[AES256_GCM,data:iT/RuwZFPltaMxvbq8S6XHr5ryRKShFCTSCsPhtiC+zQ6PZ7wbtc72r3ygHTLG2nh1j6eHdLav4h4NbQWzSHA9wUT1JalcIHeLyKUglRGhrdQOlaa8jswziiCov742Rc0tUkY3GvaVdjVzOO/aHkfD3pcO12GA69Wfab310/ekI=,iv:pXYdCnW0rHNckoaUnUeSpMhuFbIZhCYnRvNH+3SPSf4=,tag:WoPRIW5jej1uBougPLrs8Q==,type:str]
    pgp: []
    encrypted_regex: ((?i)(privateKey|displayname|email|pass|ca|id|bootstraptoken|secretboxencryptionsecret|secrets|secrets|password|cert|secret($|[^N])|key|token|^data$|^stringData))
    version: 3.9.1
