apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: heimdall-nfs
    namespace: democratic-csi
spec:
    interval: 15m
    chart:
        spec:
            chart: democratic-csi
            version: 0.14.6
            sourceRef:
                kind: HelmRepository
                name: democratic-csi
                namespace: flux-system
            interval: 15m
    timeout: 20m
    maxHistory: 3
    driftDetection:
        mode: warn
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        csiDriver:
            #ENC[AES256_GCM,data:a0b70G4MmtD9RvAWrM7U1VjjNzcpgiJpzVSwEsHSrVo9HAn7HRNfaaolMtLemg==,iv:tgTYC0vaYuoFbg3a9feR76Id4Scp2m0IH9xN6uUL5rc=,tag:2pUGTgC2QTDTRj8OvQwiNQ==,type:comment]
            name: ENC[AES256_GCM,data:TQWWhOIMcN0gEIggBT6sKw5tNzkL+Q==,iv:0agNnDZe4GUbHeDYDJkDKt05ihmsbhL+FBMMzVhR2dg=,tag:InDYlfmLUmPL+9mJDjwPsg==,type:str]
            fsGroupPolicy: ENC[AES256_GCM,data:Rlit7g==,iv:g3Z+7QOFUk+WbOPorPIAOACx0PAPpUXQNWK+e7n6gxA=,tag:AyiKmAS0ZR1eBQmwCPutPQ==,type:str]
        # add note here about volume expansion requirements
        storageClasses:
            - name: heimdall-nfs-csi
              defaultClass: true
              reclaimPolicy: Delete
              volumeBindingMode: Immediate
              allowVolumeExpansion: true
              parameters:
                # for block-based storage can be ext3, ext4, xfs
                # for nfs should be nfs
                fsType: nfs
                # if true, volumes created from other snapshots will be
                # zfs send/received instead of zfs cloned
                detachedVolumesFromSnapshots: "false"
                # if true, volumes created from other volumes will be
                # zfs send/received instead of zfs cloned
                # detachedVolumesFromVolumes: "false"
              mountOptions:
                - noatime
                - nfsvers=3
              secrets:
                provisioner-secret: null
                controller-publish-secret: null
                node-stage-secret: null
                node-publish-secret: null
                controller-expand-secret: null
        # if your cluster supports snapshots you may enable below
        volumeSnapshotClasses:
            - name: heimdall-nfs-snapshot-csi
              parameters:
                #  # if true, snapshots will be created with zfs send/receive
                detachedSnapshots: "true"
        #  secrets:
        #    snapshotter-secret:
        driver:
            config:
                driver: zfs-generic-nfs
                sshConnection:
                    host: 10.1.0.63
                    port: 22
                    username: root
                    # use either password or key
                    privateKey: ENC[AES256_GCM,data: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,iv:5/w3tLNMpwOOO1WPZ+CFWtLUwQ57BEJf7VEv+ZQER1k=,tag:KsuIZ1/IKUZ+/VTkKQ8UUg==,type:str]
                zfs:
                    # can be used to override defaults if necessary
                    # the example below is useful for TrueNAS 12
                    cli:
                        #  sudoEnabled: true
                        paths:
                            zfs: /usr/sbin/zfs
                            zpool: /usr/sbin/zpool
                            sudo: /usr/bin/sudo
                            chroot: /usr/sbin/chroot
                    # can be used to set arbitrary values on the dataset/zvol
                    # can use handlebars templates with the parameters from the storage class/CO
                    #datasetProperties:
                    #  "org.freenas:description": "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
                    #  "org.freenas:test": "{{ parameters.foo }}"
                    #  "org.freenas:test2": "some value"
                    datasetParentName: Heimdall/k8s/main-cluster
                    # do NOT make datasetParentName and detachedSnapshotsDatasetParentName overlap
                    # they may be siblings, but neither should be nested in the other
                    # do NOT comment this option out even if you don't plan to use snapshots, just leave it with dummy value
                    detachedSnapshotsDatasetParentName: Heimdall/k8s/main-cluster-snapshots
                    datasetEnableQuotas: true
                    datasetEnableReservation: false
                    datasetPermissionsMode: "0777"
                    datasetPermissionsUser: 0
                    datasetPermissionsGroup: 0
                    #datasetPermissionsAcls:
                    #- "-m everyone@:full_set:allow"
                    #- "-m u:kube:full_set:allow"
                nfs:
                    # https://docs.oracle.com/cd/E23824_01/html/821-1448/gayne.html
                    # https://www.hiroom2.com/2016/05/18/ubuntu-16-04-share-zfs-storage-via-nfs-smb/
                    shareStrategy: setDatasetProperties
                    shareStrategySetDatasetProperties:
                        properties:
                            #sharenfs: "rw,no_subtree_check,no_root_squash"
                            sharenfs: "on"
                            # share: ""
                    shareHost: 10.1.0.63
sops:
    shamir_threshold: 3
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1agltukf6ellg2guets9gq4th2nmunc965uflry7fdahtj7ea8uxq8q54ae
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBhOE1lZDFiRFFKODJ4RWFN
            YndOajJrakgzYUVFcnN6MHR4N2laSzlZclVRCkpqZHJYU3R4ek1OWE9PMGpZUUJS
            cWM2bnlxZllDWnErRTJzdUYrcnRpWTQKLS0tIGJSKzl3UlEvbFFDdE1raWRaT0N5
            R2c4Rk5oaERvQkx5eTVYTXhKMHd0a2MKyhL3+MmUsX8CsBOBLAxltfWh1tTaPbxa
            qQEJI3oWKGAmXjf+QggRM8sJEKEuK1Nc/oDuV6TxP/SKFz3eX5r9gg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-01T23:50:10Z"
    mac: ENC[AES256_GCM,data:N9nnesCbHyqmSIqStNo6mwON45Fv7W6boJYhVxc1laNl1LUpLU9wD9U4O+BF9te5HPwSJ0I6Q+uc+1n5qsuMBjR9YUPeH7wvuVW0Zj7/j1Emq2/nW2y3mNnHd2M8e/HTAg2lF2V6hE9voAoM+u33UNufiswT3YnoncY4M+zc8JM=,iv:hLjTQWS/oORRO9ZplTk/JX0nq3gXv0a9f1fhGBfu4H0=,tag:JRz/0PbeOWHK0FzAhxHrBw==,type:str]
    pgp: []
    encrypted_regex: ((?i)(privateKey|displayname|email|pass|ca|id|bootstraptoken|secretboxencryptionsecret|secrets|secrets|password|cert|secret($|[^N])|key|token|^data$|^stringData))
    version: 3.9.1
