apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: heimdall-nfs
    namespace: democratic-csi
spec:
    interval: 15m
    chart:
        spec:
            chart: democratic-csi
            version: 0.14.6
            sourceRef:
                kind: HelmRepository
                name: democratic-csi
                namespace: flux-system
            interval: 15m
    timeout: 20m
    maxHistory: 3
    driftDetection:
        mode: warn
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        csiDriver:
            # should be globally unique for a given cluster
            name: org.democratic-csi.nfs
            fsGroupPolicy: File
        # add note here about volume expansion requirements
        storageClasses:
            - name: heimdall-nfs-csi
              defaultClass: true
              reclaimPolicy: Delete
              volumeBindingMode: Immediate
              allowVolumeExpansion: true
              parameters:
                # for block-based storage can be ext3, ext4, xfs
                # for nfs should be nfs
                fsType: nfs
                # if true, volumes created from other snapshots will be
                # zfs send/received instead of zfs cloned
                detachedVolumesFromSnapshots: "false"
                # if true, volumes created from other volumes will be
                # zfs send/received instead of zfs cloned
                # detachedVolumesFromVolumes: "false"
              mountOptions:
                - noatime
                - nfsvers=3
              secrets:
                provisioner-secret: null
                controller-publish-secret: null
                node-stage-secret: null
                node-publish-secret: null
                controller-expand-secret: null
        # if your cluster supports snapshots you may enable below
        volumeSnapshotClasses:
            - name: heimdall-nfs-snapshot-csi
              parameters:
                #  # if true, snapshots will be created with zfs send/receive
                detachedSnapshots: "true"
        #  secrets:
        #    snapshotter-secret:
        driver:
            config:
                driver: zfs-generic-nfs
                sshConnection:
                    host: 10.1.0.63
                    port: 22
                    username: root
                    # use either password or key
                    privateKey: ENC[AES256_GCM,data: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,iv:g2FrGR19gvRg5w8tYb9DytbKVWUoAJhdQF5Esp5pXg0=,tag:o4rB4ZFYhRpJMDj4Q2nugw==,type:str]
                zfs:
                    # can be used to override defaults if necessary
                    # the example below is useful for TrueNAS 12
                    cli:
                        #  sudoEnabled: true
                        paths:
                            zfs: /usr/sbin/zfs
                            zpool: /usr/sbin/zpool
                            sudo: /usr/bin/sudo
                            chroot: /usr/sbin/chroot
                    # can be used to set arbitrary values on the dataset/zvol
                    # can use handlebars templates with the parameters from the storage class/CO
                    #datasetProperties:
                    #  "org.freenas:description": "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
                    #  "org.freenas:test": "{{ parameters.foo }}"
                    #  "org.freenas:test2": "some value"
                    datasetParentName: Heimdall/k8s/main-cluster
                    # do NOT make datasetParentName and detachedSnapshotsDatasetParentName overlap
                    # they may be siblings, but neither should be nested in the other
                    # do NOT comment this option out even if you don't plan to use snapshots, just leave it with dummy value
                    detachedSnapshotsDatasetParentName: Heimdall/k8s/main-cluster-snapshots
                    datasetEnableQuotas: true
                    datasetEnableReservation: false
                    datasetPermissionsMode: "0777"
                    datasetPermissionsUser: 0
                    datasetPermissionsGroup: 0
                    #datasetPermissionsAcls:
                    #- "-m everyone@:full_set:allow"
                    #- "-m u:kube:full_set:allow"
                nfs:
                    # https://docs.oracle.com/cd/E23824_01/html/821-1448/gayne.html
                    # https://www.hiroom2.com/2016/05/18/ubuntu-16-04-share-zfs-storage-via-nfs-smb/
                    shareStrategy: setDatasetProperties
                    shareStrategySetDatasetProperties:
                        properties:
                            #sharenfs: "rw,no_subtree_check,no_root_squash"
                            sharenfs: "on"
                            # share: ""
                    shareHost: 10.1.0.63
sops:
    shamir_threshold: 3
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1agltukf6ellg2guets9gq4th2nmunc965uflry7fdahtj7ea8uxq8q54ae
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSAzTDAyL3ZaRlRFL04zWito
            UllUVHdGb2hUUVVmaGFrQ29MV2M0cGphcUV3CjNFTFE2b0oycmFZMWdyc3dldGFH
            ck9zWFZBRzFpWU5vQWtyWjB4QkhjZlkKLS0tIDh0VHk1blBCQ3ZXSnJlYk5DT0lx
            MUZ2aGFiTDhudzROTkVqcER4bXkxNVUKMWqNPZo6k3D+FYG+QmV8mKs0Xm1rqljF
            xnPjEFmsJd6bDndEyTgCLSgpCEMASgtNGOckqwZiBaiWDproGTLpqg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-03T00:24:15Z"
    mac: ENC[AES256_GCM,data:ESiL7QfkoaKQhn9YYc14TfReS7U6arBXZaCbNHCRH99is9/fJgAkOEMQiTbJDzAmXDGVEqh8BDyKbWZDCh1NOLhbEi/KrXGJ6W+eP1N6hLv819ocrgYV9iMBa/yIpepn6lELXQ5TgtGkQSBDJjMn7z2j34E0iPq0B1GUh1tpxBk=,iv:oQteGqvEVem8o3P1zJA2b4/VTVyGEUjln6wtTPCyW+Y=,tag:mzHG/oCJVXfxfYUCB1dvJg==,type:str]
    pgp: []
    encrypted_regex: ((?i)(privateKey))
    version: 3.9.1
