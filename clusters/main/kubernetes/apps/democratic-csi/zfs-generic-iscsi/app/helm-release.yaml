apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: heimdall-iscsi
    namespace: democratic-csi
spec:
    interval: 15m
    chart:
        spec:
            chart: democratic-csi
            version: 0.14.6
            sourceRef:
                kind: HelmRepository
                name: democratic-csi
                namespace: flux-system
            interval: 15m
    timeout: 20m
    maxHistory: 3
    driftDetection:
        mode: warn
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        node:
            hostPID: ENC[AES256_GCM,data:P4Dmow==,iv:IDgCSxp1IKY0pGtzygXM76GKrtu5sXdnTSLYAZjCcGE=,tag:hcC1HJmPmKcmm1RGYr27QQ==,type:bool]
            driver:
                extraEnv:
                    - name: ISCSIADM_HOST_STRATEGY
                      value: nsenter
                    - name: ISCSIADM_HOST_PATH
                      value: /usr/local/sbin/iscsiadm
                iscsiDirHostPath: ENC[AES256_GCM,data:nX2BoXoLS/yyGE4LRzMiFQfWBDY=,iv:ooqutkfKE23NkO+rS+Ojoeh3VlhMxwDq0RCasLveevM=,tag:JpjO5bk2cbns9ZC5U6k6Ww==,type:str]
                iscsiDirHostPathType: ""
        csiDriver:
            #ENC[AES256_GCM,data:gcaq7KVAB9v6z3eXZshNDc55wYXWgiTfFFQpH74tmbqW+SmdCopg3aUT9JR4Iw==,iv:6zknML/VCb/5JoRg/PgcQ53wFuuAydQwL92gK2HdDV8=,tag:vvgoTl7ukc9tC83cwy8n9Q==,type:comment]
            name: ENC[AES256_GCM,data:gFq6fA+KNsVnM9cjfZCWcmYb8BPqTfkG,iv:Ll1I/KMGFWFCk6wZgKHncDB0hHg07SUigPHdsHrrUgA=,tag:QbZ6buL7lv7AlCMclGKZ3g==,type:str]
        # add note here about volume expansion requirements
        storageClasses:
            - name: heimdall-iscsi-csi
              defaultClass: false
              reclaimPolicy: Delete
              volumeBindingMode: Immediate
              allowVolumeExpansion: true
              parameters:
                # for block-based storage can be ext3, ext4, xfs
                # for nfs should be nfs
                fsType: ext4
                # if true, volumes created from other snapshots will be
                # zfs send/received instead of zfs cloned
                # detachedVolumesFromSnapshots: "false"
                # if true, volumes created from other volumes will be
                # zfs send/received instead of zfs cloned
                # detachedVolumesFromVolumes: "false"
              mountOptions: []
              secrets:
                provisioner-secret: null
                controller-publish-secret: null
                node-stage-secret: null
                #ENC[AES256_GCM,data:T0InE6v2opEy/id53B6RBlcylpqzQetIHyZXNX6edp2fNnBUsdPiRf7SCzZfxH6Z3iZYlrhRQWnPTMgWRgayPDMz0WSSTxeitKNpjsrPGgpyTXR01PposJqsGGc9PKvg1ruIax0=,iv:6rLU7s76SjJMO2/k5A3iYh7AwP57lEXfDSv8EaBj03I=,tag:NaV+diEoiCbaO6QALB2ISA==,type:comment]
                #ENC[AES256_GCM,data:mqk4NGKRF5WUq5XE9NBdOtImwsQq,iv:quUdp05lLqr97D0NdBrVK1nFoa4b2b3FasozjDN/bA8=,tag:PG33DRM6ATt9fnWKry5COQ==,type:comment]
                #ENC[AES256_GCM,data:Pd4fZiqN/0mHLdMuq997ms/qWUhDxStMoOd9rCWEMr/XUHr0s1KuElPXj4MSFlmd,iv:jhn7xXBjycEhBEhhdkCnZEC6iwwR+E6PSDACSkCN5XA=,tag:Hpo75GfFjr+gaB22Iyzyig==,type:comment]
                #ENC[AES256_GCM,data:YrhvGRq2BTN6IUhU2O3fpMUS4A3Jbdrf1iQ7LBO0KZKnlW5KAuTXaZyNOA6k,iv:IFDL7Vxkdfae10J791YIIuXrTvrvYm5yjYvKIhVhKvg=,tag:FM2MXLsEblcls4M1ls8PVQ==,type:comment]
                #ENC[AES256_GCM,data:WKe3hZ4Fl9PBf14F1YcoJoMIcpng5c5kBssV9QvbgUzyTTWAoJAS8m0IG/cR,iv:Zx+JqixMhYeYT4gzQPEFqLZLLYVFdzGXjd7JsUTYzqQ=,tag:3nwvTvVXVPCryU+/zXKIzw==,type:comment]
                #
                #ENC[AES256_GCM,data:v5absf36nRBqYeNdgWTyGlu8lNve3jqQZcHMxg==,iv:1GTSf9xGb2/HQl8R+nHxTi6SgbNryVfcYjwlpNd59gY=,tag:4DwCSSUSUA9SLdOhMfSTYw==,type:comment]
                #ENC[AES256_GCM,data:oz/xRXPv1L4uAWCqqnIjmRXHcYgTn62e41TKgpSx9LCkxyh5SpHEXVydNn0W1iGH,iv:eOsvY6027Rz1lqE3nTFgfLa94CaQoitQ+Q/qEE3qYlU=,tag:47twOPu3IyV0SuOWij/48Q==,type:comment]
                #ENC[AES256_GCM,data:HXumxe0jYdluDxk3TLWM2nOiMkzhWrARDTpW1jiQKfb+5BGOIzUl3vxh08EwLPGc,iv:xIcL/WRS8YWZxFsjDdL+olH6oKI1XIYEmlKzAX5IIGs=,tag:EUyTrWS7sf//rqsCFNJswQ==,type:comment]
                node-publish-secret: null
                controller-expand-secret: null
        # if your cluster supports snapshots you may enable below
        volumeSnapshotClasses:
            - name: heimdall-iscsi-snapshot-csi
              parameters:
                #  # if true, snapshots will be created with zfs send/receive
                detachedSnapshots: "true"
        #  secrets:
        #    snapshotter-secret:
        driver:
            config:
                driver: zfs-generic-iscsi
                sshConnection:
                    host: 10.1.0.63
                    port: 22
                    username: root
                    # use either password or key
                    privateKey: ENC[AES256_GCM,data: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,iv:jIrm3M6AXMHHN1GeNdKh/mwqvuE4NItUt+QR0gDpl4k=,tag:WEohB1IdpFrvVVTbgsX/9A==,type:str]
                zfs:
                    # can be used to override defaults if necessary
                    # the example below is useful for TrueNAS 12
                    cli:
                        #  sudoEnabled: true
                        paths:
                            zfs: /usr/sbin/zfs
                            zpool: /usr/sbin/zpool
                            sudo: /usr/bin/sudo
                            chroot: /usr/sbin/chroot
                    # can be used to set arbitrary values on the dataset/zvol
                    # can use handlebars templates with the parameters from the storage class/CO
                    #datasetProperties:
                    #  "org.freenas:description": "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
                    #  "org.freenas:test": "{{ parameters.foo }}"
                    #  "org.freenas:test2": "some value"
                    datasetParentName: Heimdall/k8s/main-cluster
                    # do NOT make datasetParentName and detachedSnapshotsDatasetParentName overlap
                    # they may be siblings, but neither should be nested in the other
                    # do NOT comment this option out even if you don't plan to use snapshots, just leave it with dummy value
                    detachedSnapshotsDatasetParentName: Heimdall/k8s/main-cluster-snapshots
                    # "" (inherit), lz4, gzip-9, etc
                    zvolCompression: inherit
                    # "" (inherit), on, off, verify
                    zvolDedup: inherit
                    zvolEnableReservation: false
                    # 512, 1K, 2K, 4K, 8K, 16K, 64K, 128K default is 16K
                    zvolBlocksize: null
                iscsi:
                    shareStrategy: targetCli
                    # https://kifarunix.com/how-to-install-and-configure-iscsi-storage-server-on-ubuntu-18-04/
                    # https://kifarunix.com/how-install-and-configure-iscsi-storage-server-on-centos-7/
                    # https://linuxlasse.net/linux/howtos/ISCSI_and_ZFS_ZVOL
                    # http://www.linux-iscsi.org/wiki/ISCSI
                    # https://bugzilla.redhat.com/show_bug.cgi?id=1659195
                    # http://atodorov.org/blog/2015/04/07/how-to-configure-iscsi-target-on-red-hat-enterprise-linux-7/
                    shareStrategyTargetCli:
                        #sudoEnabled: true
                        basename: iqn.2003-01.org.linux-iscsi.proxmox-82.x8664
                        tpg:
                            attributes:
                                # set to 1 to enable CHAP
                                authentication: ENC[AES256_GCM,data:LA==,iv:w+LuE0bR+7Vkw1lQbrUgvHSfOBj0hMmsVIvgUYQxRlg=,tag:nDwtgVx6dv/dJb7eO2enhQ==,type:int]
                                # this is required currently as we do not register all node iqns
                                # the effective outcome of this is, allow all iqns to connect
                                generate_node_acls: 1
                                cache_dynamic_acls: ENC[AES256_GCM,data:WQ==,iv:i7VpAl0M7q3Vp4yBmXu3E+B8sXm5xm88Z8zqk5Zt1H0=,tag:r+RRzG9uGbsjpRgvXeXy6w==,type:int]
                                # if generate_node_acls is 1 then must turn this off as well (assuming you want write ability)
                                demo_mode_write_protect: 0
                            auth: null
                            # CHAP
                            #userid: "foo"
                            #password: "bar"
                            # mutual CHAP
                            #mutual_userid: "baz"
                            #mutual_password: "bar"
                        block:
                            attributes:
                                # set to 1 to enable Thin Provisioning Unmap
                                emulate_tpu: 0
                    targetPortal: 10.1.0.63:3260
                    # for multipath
                    targetPortals: []
                    # leave empty to omit usage of -I with iscsiadm
                    interface: ""
                    # MUST ensure uniqueness
                    # full iqn limit is 223 bytes, plan accordingly
                    # default is "{{ name }}"
                    #nameTemplate: "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}-{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
                    namePrefix: csi-
                    nameSuffix: -cluster
sops:
    shamir_threshold: 3
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1agltukf6ellg2guets9gq4th2nmunc965uflry7fdahtj7ea8uxq8q54ae
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA1M3JCYW5La2pPYkdDek9j
            U2RlTjkzeVN3eDBXLzIvblFaS2Y0bFowdXg0CjhVTG5GNktiL0NHTWNFQmczdkVQ
            WnFqZ1F3YUIzMXErdlRGSzVERU1aOWMKLS0tIFh2ZkVaVnZITlIwQUhTQVNQZktx
            VzdLTFIrMUVhMi9ieUp1bFZSOFpVckEKvdccgfBeYy6hDXfhSE5vvrmQMccVi+zV
            HbqWLBRmwxzmmWyEsa7gOjVPwPWe3Jy/B7u9Y35bAwbFufIwVyAaqA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-01T23:50:10Z"
    mac: ENC[AES256_GCM,data:orZThlzxQJC3CdVN53EBa0B4vIXcXt/IFYos8b3PbNxP/kfP8xuicH62m4k3ND0ikE1dnquQSYnVS/sQDgA/eKIBu789xYglnOpAPLviqTQ4z0U4XWGXOcc6xvHCyczWATGC3N5cW1Q6r9zb5jBWNHtxvMIvxuBZOx5rAKqmEjk=,iv:CTl3L4HIWRjyJEXmlFRwII+ik/m/7z//O3X3Efbwft0=,tag:tgETLcWho8FR6j3W1fCaTQ==,type:str]
    pgp: []
    encrypted_regex: ((?i)(privateKey|displayname|email|pass|ca|id|bootstraptoken|secretboxencryptionsecret|secrets|secrets|password|cert|secret($|[^N])|key|token|^data$|^stringData))
    version: 3.9.1
